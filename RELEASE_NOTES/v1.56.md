# v1.56 — Robust LoRA re-compose after device transitions; safe retry when 0 targets detected

## Summary
- Fixes a frequent edge case where, after a crash or CPU offloading transitions, LoRA composition could end up applying to 0 target modules.
- Adds two minimal, backward-compatible safety mechanisms:
  - Device transition detection → force re-compose
  - One-time reset+re-compose retry when composition returns 0 targets
- Normal flows remain unchanged.

## Problem
- Some users see “Applied LoRA compositions to 0 module” after a crash or when toggling CPU offload (enable/disable/auto).
- Root cause: the underlying transformer’s device/offload-manager state may change, making the LoRA target discovery return an empty set, or the previous change detection logic fails to re-apply when the device changed but the LoRA list did not.

## Technical Solution
- Device transition detection:
  - Track last known device on the wrapped transformer.
  - If device changes (e.g., CPU⇄GPU), treat it as a change and force re-compose.
- Safe retry on zero targets:
  - After compose, if the model reports no LoRA target slots and there are LoRAs to apply, perform one reset+compose retry.
  - Limited to a single retry to avoid loops.

## Code Changes
- File: `wrappers/qwenimage.py`
- Key edits:
  - Added `self._last_device` to track device signature.
  - Extended change detection with `device_changed`.
  - After compose, validate target slots; if zero (while LoRAs exist), run one forced reset→re-compose retry.
- The rest of the pipeline (reset→compose→offload manager rebuild) remains unchanged.

### Code-level Explanation (with references)

1) Track last device to detect CPU/GPU moves

```60:66:D:\USERFILES\GitHub\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py
        self._linspace_cache_w = {}

        # Track last seen device to detect CPU/GPU moves that require re-compose
        self._last_device = None
```

2) Compute current device and detect change

```101:110:D:\USERFILES\GitHub\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py
        # Detect device transition (e.g., CPU offload on/off) and force re-compose
        try:
            current_device = next(self.model.parameters()).device
        except Exception:
            current_device = None
        device_changed = (self._last_device != current_device)
```

3) Include `device_changed` in re-compose trigger

```110:116:D:\USERFILES\GitHub\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py
        if loras_changed or model_is_dirty or device_changed:
            # The compose function handles resetting before applying the new stack
            reset_lora_v2(self.model)
            self._applied_loras = self.loras.copy()
```

4) Retry once if compose produced 0 targets after crash/transition

```150:170:D:\USERFILES\GitHub\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py
            # 4. Compose LoRAs. This changes internal tensor shapes.
            compose_loras_v2(self.model, self.loras)

            # Validate composition result; if 0 targets after a crash/transition, retry once
            try:
                has_slots = hasattr(self.model, "_lora_slots") and bool(self.model._lora_slots)
            except Exception:
                has_slots = True
            if self.loras and not has_slots:
                logger.warning("LoRA composition reported 0 target modules. Forcing reset and one retry.")
                try:
                    reset_lora_v2(self.model)
                    compose_loras_v2(self.model, self.loras)
                except Exception as e:
                    logger.error(f"LoRA re-compose retry failed: {e}")
```

5) Update device signature after composition (success path)

```176:181:D:\USERFILES\GitHub\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py
            # --- END MODIFIED SECTION ---

            # Update last known device signature after (re)composition
            self._last_device = current_device
```

Rationale
- Device changes (CPU↔GPU or offload rebuild) can invalidate prior target discovery. By detecting transitions, we ensure reset→compose runs even when the LoRA list is unchanged.
- A single retry on 0-target avoids false negatives immediately after crashes or manager rebuilds, without masking persistent problems.
- No change to normal execution: when device is stable and target discovery succeeds, additional logic is dormant.

## Expected Impact
- After crashes/offload toggles, the loader will auto-recover instead of silently applying to 0 modules.
- No changes to UI, node I/O, or normal execution paths.
- Backward compatible. No behavior change when things are healthy.

## How to Verify
- Single LoRA:
  - Apply a LoRA, tweak strength ±0.01, re-run → still applied.
- Stack LoRA:
  - Set `lora_count=3`, assign 2–3 LoRAs, toggle `lora_count` 1→3→1, re-run → applied consistently.
- Offload:
  - Switch offload disable/enable/auto and re-run → still applied.
- Edge:
  - If composition ever reports 0 targets, a single retry is attempted automatically (warning is logged once).

## Acknowledgments
- This update is derived from real-world reports that became more visible post-crash scenarios and offload transitions. Thank you to everyone raising and discussing similar patterns.

## Links
- Tags page: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/tags
- v1.56 release: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/releases/tag/v1.56


