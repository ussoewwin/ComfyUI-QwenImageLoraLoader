# v1.56 — Robust LoRA re-compose after device transitions; safe retry when 0 targets detected

## Summary
- Fixes a frequent edge case where, after a crash or CPU offloading transitions, LoRA composition could end up applying to 0 target modules.
- Adds two minimal, backward-compatible safety mechanisms:
  - Device transition detection → force re-compose
  - One-time reset+re-compose retry when composition returns 0 targets
- Normal flows remain unchanged.

## Problem
- Some users see “Applied LoRA compositions to 0 module” after a crash or when toggling CPU offload (enable/disable/auto).
- Root cause: the underlying transformer’s device/offload-manager state may change, making the LoRA target discovery return an empty set, or the previous change detection logic fails to re-apply when the device changed but the LoRA list did not.

## Technical Solution
- Device transition detection:
  - Track last known device on the wrapped transformer.
  - If device changes (e.g., CPU⇄GPU), treat it as a change and force re-compose.
- Safe retry on zero targets:
  - After compose, if the model reports no LoRA target slots and there are LoRAs to apply, perform one reset+compose retry.
  - Limited to a single retry to avoid loops.

## Code Changes
- File: `wrappers/qwenimage.py`
- Key edits:
  - Added `self._last_device` to track device signature.
  - Extended change detection with `device_changed`.
  - After compose, validate target slots; if zero (while LoRAs exist), run one forced reset→re-compose retry.
- The rest of the pipeline (reset→compose→offload manager rebuild) remains unchanged.

## Expected Impact
- After crashes/offload toggles, the loader will auto-recover instead of silently applying to 0 modules.
- No changes to UI, node I/O, or normal execution paths.
- Backward compatible. No behavior change when things are healthy.

## How to Verify
- Single LoRA:
  - Apply a LoRA, tweak strength ±0.01, re-run → still applied.
- Stack LoRA:
  - Set `lora_count=3`, assign 2–3 LoRAs, toggle `lora_count` 1→3→1, re-run → applied consistently.
- Offload:
  - Switch offload disable/enable/auto and re-run → still applied.
- Edge:
  - If composition ever reports 0 targets, a single retry is attempted automatically (warning is logged once).

## Acknowledgments
- This update is derived from real-world reports that became more visible post-crash scenarios and offload transitions. Thank you to everyone raising and discussing similar patterns.

## Links
- Tags page: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/tags
- v1.56 release: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/releases/tag/v1.56


