## Summary

- **Added**: V2 loader with ComfyUI Nodes 2.0 (Beta) support
- **New Node**: `NunchakuQwenImageLoraStackV2` - V2 loader node added
- **Fixed**: Resolved [Issue #9](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/9) ‚Äì The 10th LoRA control row no longer displays when `lora_count` is set to less than 10. Dynamic UI now correctly hides unused LoRA slots and adjusts node height automatically
- **Problem**: ComfyUI Nodes 2.0 (Beta) compatibility required a new approach to widget management, as traditional widget hiding methods no longer work
- **Solution**: Implemented V2 loader using `optional` inputs and Flux V2-style widget array reconstruction for complete ComfyUI Nodes 2.0 (Beta) compatibility

## Problem

### ComfyUI Nodes 2.0 (Beta) Compatibility Issue

- ComfyUI Nodes 2.0 (Beta) introduced changes to the widget system that broke traditional widget hiding methods
- The original `NunchakuQwenImageLoraStack` (V1) node used `required` inputs for all LoRA slots, which caused display issues
- JavaScript-based widget hiding techniques (like `widgethider.js`) no longer work reliably with ComfyUI Nodes 2.0 (Beta)
- The 10th LoRA control row always displayed regardless of the selected `lora_count` value ([Issue #9](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/9))
- Reported by: @xingewh (GitHub Issue #9)

### Root Cause

**V1 Implementation (`nodes/lora/qwenimage.py`):**
- All LoRA inputs were defined as `required` in `INPUT_TYPES()`
- JavaScript attempted to hide widgets using `widgethider.js` with negative height values
- ComfyUI Nodes 2.0 (Beta) changed how widgets are rendered, making this approach ineffective
- The widget array structure could not be dynamically modified after node creation

**V1 Code Structure:**
```python
inputs = {
    "required": {
        "model": ("MODEL", {...}),
        "lora_count": ("INT", {...}),
        "cpu_offload": (["auto", "enable", "disable"], {...}),
    },
}
# All LoRA slots added as required
for i in range(1, 11):
    inputs["required"][f"lora_name_{i}"] = (loras, {...})
    inputs["required"][f"lora_strength_{i}"] = ("FLOAT", {...})
```

## Technical Solution

### Architecture Overview

The V2 loader implements a completely new architecture based on ComfyUI Nodes 2.0 (Beta) best practices:

1. **Optional Inputs**: All LoRA slots are defined as `optional` inputs instead of `required`
2. **Widget Array Reconstruction**: JavaScript physically reconstructs the `widgets` array based on `lora_count`
3. **Hidden Widget Sync**: V1's `lora_count` widget is hidden but kept in sync with V2's control widget
4. **Dynamic Height Calculation**: Node height automatically adjusts based on visible LoRA slots
5. **Flux V2-Style Implementation**: Follows the same pattern used in Flux V2 LoRA stacker nodes

### Key Design Decisions

- **Backward Compatibility**: V1 node (`NunchakuQwenImageLoraStack`) remains available for users who haven't upgraded to ComfyUI Nodes 2.0 (Beta)
- **Feature Parity**: V2 node provides complete feature parity with V1, including CPU offload support
- **Clean UI**: Only visible LoRA slots are included in the widget array, eliminating display issues

## Code Changes

### Files Added

1. `nodes/lora/qwenimage_v2.py` - New V2 node implementation
2. `js/z_qwen_lora_dynamic.js` - JavaScript widget management for V2 node

### Files Modified

1. `__init__.py` - Added V2 node registration using `GENERATED_NODES` pattern

### Key Changes

#### 1. V2 Node Implementation (`nodes/lora/qwenimage_v2.py`)

**New Class Structure:**
```python
class NunchakuQwenImageLoraStackV2:
    """
    Node for loading and applying multiple LoRAs to a Nunchaku Qwen Image model with dynamic UI.
    """
```

**Key Difference: Optional Inputs**

**V1 (Required Inputs):**
```python
inputs = {
    "required": {
        "model": ("MODEL", {...}),
        "lora_count": ("INT", {...}),
        "cpu_offload": (["auto", "enable", "disable"], {...}),
    },
}
# All LoRA slots as required
for i in range(1, 11):
    inputs["required"][f"lora_name_{i}"] = (loras, {...})
    inputs["required"][f"lora_strength_{i}"] = ("FLOAT", {...})
```

**V2 (Optional Inputs):**
```python
inputs = {
    "required": {
        "model": ("MODEL", {...}),
        "lora_count": ("INT", {...}),
        "cpu_offload": (["auto", "enable", "disable"], {...}),
    },
    "optional": {},  # ‚Üê New optional section
}

# All LoRA slots as optional
for i in range(1, 11):
    inputs["optional"][f"lora_name_{i}"] = (  # ‚Üê Changed to optional
        loras,
        {"tooltip": f"The file name of LoRA {i}. Select 'None' to skip this slot."},
    )
    inputs["optional"][f"lora_strength_{i}"] = (  # ‚Üê Changed to optional
        "FLOAT",
        {
            "default": 1.0,
            "min": -100.0,
            "max": 100.0,
            "step": 0.01,
            "tooltip": f"Strength for LoRA {i}.",
        },
    )
```

**Processing Logic:**
```python
def load_lora_stack(self, model, lora_count, cpu_offload, **kwargs):
    loras_to_apply = []
    
    # Process only the number of LoRAs specified by lora_count
    for i in range(1, lora_count + 1):  # ‚Üê Only process up to lora_count
        lora_name = kwargs.get(f"lora_name_{i}")
        lora_strength = kwargs.get(f"lora_strength_{i}", 1.0)
        
        # Skip if lora_name is None or strength is negligible
        if lora_name and lora_name != "None" and abs(lora_strength) > 1e-5:
            loras_to_apply.append((lora_name, lora_strength))
    
    # ... rest of implementation
```

#### 2. JavaScript Widget Management (`js/z_qwen_lora_dynamic.js`)

**Widget Caching System:**
```javascript
const initCache = () => {
    if (cacheReady) return;
    const all = [...node.widgets];
    
    // Cache lora_count widget (required for Python backend, but hidden in UI)
    const loraCountWidget = all.find(w => w.name === "lora_count");
    if (loraCountWidget) {
        node.cachedLoraCount = loraCountWidget;
        // Hide V1's lora_count widget using HIDDEN_TAG
        loraCountWidget.type = HIDDEN_TAG;
        loraCountWidget.computeSize = () => [0, -4];
    }
    
    // Cache cpu_offload widget
    const cpuOffloadWidget = all.find(w => w.name === "cpu_offload");
    if (cpuOffloadWidget) {
        node.cachedCpuOffload = cpuOffloadWidget;
    }
    
    // Cache all LoRA widgets (1-10)
    for (let i = 1; i <= 10; i++) {
        const wName = all.find(w => w.name === `lora_name_${i}`);
        const wStrength = all.find(w => w.name === `lora_strength_${i}`);
        if (wName && wStrength) {
            node.cachedWidgets[i] = [wName, wStrength];
        }
    }
    cacheReady = true;
};
```

**Control Widget Creation:**
```javascript
const ensureControlWidget = () => {
    const name = "üî¢ LoRA Count";
    
    // Remove old button widgets
    for (let i = node.widgets.length - 1; i >= 0; i--) {
        const w = node.widgets[i];
        if (w.name === "üî¢ Set LoRA Count" || w.type === "button") {
            node.widgets.splice(i, 1);
        }
    }

    let w = node.widgets.find(x => x.name === name);
    if (!w) {
        const values = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
        w = node.addWidget("combo", name, "1", (v) => {
            const num = parseInt(v);
            if (!isNaN(num)) {
                node.properties["visibleLoraCount"] = num;
                // Sync with lora_count widget for Python backend
                if (node.cachedLoraCount) {
                    node.cachedLoraCount.value = num;
                }
                node.updateLoraSlots();
            }
        }, { values });
    }
    w.value = node.properties["visibleLoraCount"].toString();
    // Sync lora_count widget value
    if (node.cachedLoraCount) {
        node.cachedLoraCount.value = node.properties["visibleLoraCount"];
    }
    return w;
};
```

**Widget Array Reconstruction (Flux V2-Style):**
```javascript
node.updateLoraSlots = function() {
    if (!cacheReady) initCache();

    const count = parseInt(this.properties["visibleLoraCount"] || 1);
    const controlWidget = ensureControlWidget();

    // Physical widget reconstruction for clean layout (like Flux V2)
    this.widgets = [controlWidget];  // ‚Üê Start fresh with control widget

    // Add lora_count widget (required for Python backend, but hidden in UI)
    if (node.cachedLoraCount) {
        node.cachedLoraCount.type = HIDDEN_TAG;
        node.cachedLoraCount.computeSize = () => [0, -4];
        node.cachedLoraCount.value = count;  // ‚Üê Sync value
        this.widgets.push(node.cachedLoraCount);  // ‚Üê Add to array but hidden
    }

    // Add cpu_offload widget from cache
    if (node.cachedCpuOffload) {
        this.widgets.push(node.cachedCpuOffload);
    }

    // Add only visible LoRA slots (non-visible widgets are removed from array)
    for (let i = 1; i <= count; i++) {  // ‚Üê Only add up to count
        const pair = this.cachedWidgets[i];
        if (pair) {
            this.widgets.push(pair[0]);  // lora_name
            this.widgets.push(pair[1]);  // lora_strength
        }
    }

    // Height calculation
    const HEADER_H = 60;
    const SLOT_H = 54;
    const CPU_OFFLOAD_H = node.cachedCpuOffload ? 40 : 0;
    const PADDING = 20;
    const targetH = HEADER_H + CPU_OFFLOAD_H + (count * SLOT_H) + PADDING;
    
    this.setSize([this.size[0], targetH]);  // ‚Üê Dynamic height adjustment
    
    if (app.canvas) app.canvas.setDirty(true, true);
};
```

**Key Features:**
- **Physical Array Reconstruction**: `this.widgets = [controlWidget]` creates a fresh array
- **Selective Widget Addition**: Only widgets for visible slots (1 to `count`) are added
- **Hidden Widget Sync**: V1's `lora_count` widget is hidden but kept in sync for Python backend
- **Dynamic Height**: Node height calculated based on visible slots: `HEADER_H + CPU_OFFLOAD_H + (count * SLOT_H) + PADDING`

#### 3. Node Registration (`__init__.py`)

**V2 Node Registration:**
```python
from nodes.lora.qwenimage_v2 import GENERATED_NODES, GENERATED_DISPLAY_NAMES

# Register V2 node
NODE_CLASS_MAPPINGS.update(GENERATED_NODES)
NODE_DISPLAY_NAME_MAPPINGS.update(GENERATED_DISPLAY_NAMES)
```

**V2 Node Export (`nodes/lora/qwenimage_v2.py`):**
```python
GENERATED_NODES = {
    "NunchakuQwenImageLoraStackV2": NunchakuQwenImageLoraStackV2
}

GENERATED_DISPLAY_NAMES = {
    "NunchakuQwenImageLoraStackV2": "Nunchaku Qwen Image LoRA Stack V2"
}
```

## Behavior Changes

### UI Behavior

**V1 (Before):**
- All 10 LoRA slots always visible in UI
- 10th slot always displayed regardless of `lora_count` setting
- Node height fixed regardless of visible slots
- JavaScript attempted to hide widgets but failed with ComfyUI Nodes 2.0 (Beta)

**V2 (After):**
- Only LoRA slots up to `lora_count` are visible
- 10th slot correctly hidden when `lora_count < 10`
- Node height automatically adjusts based on visible slots
- Clean widget array with only visible widgets included

### Widget Management

**V1 Approach:**
- All widgets defined as `required`
- JavaScript tried to hide widgets using `widgethider.js`
- Widget array structure fixed after node creation
- Failed with ComfyUI Nodes 2.0 (Beta)

**V2 Approach:**
- All LoRA widgets defined as `optional`
- JavaScript physically reconstructs widget array
- Only visible widgets included in array
- Works perfectly with ComfyUI Nodes 2.0 (Beta)

### Node Height Calculation

**V2 Dynamic Height:**
```javascript
const HEADER_H = 60;           // Node header height
const SLOT_H = 54;              // Height per LoRA slot
const CPU_OFFLOAD_H = 40;       // CPU offload widget height (if present)
const PADDING = 20;              // Bottom padding
const targetH = HEADER_H + CPU_OFFLOAD_H + (count * SLOT_H) + PADDING;
```

**Examples:**
- `lora_count = 1`: Height = 60 + 40 + (1 √ó 54) + 20 = 174px
- `lora_count = 3`: Height = 60 + 40 + (3 √ó 54) + 20 = 282px
- `lora_count = 10`: Height = 60 + 40 + (10 √ó 54) + 20 = 660px

## Benefits

- ‚úÖ **ComfyUI Nodes 2.0 (Beta) Compatibility**: Full support for ComfyUI Nodes 2.0 (Beta) widget system
- ‚úÖ **Issue #9 Fixed**: 10th LoRA control row no longer displays when `lora_count < 10`
- ‚úÖ **Clean UI**: Only visible LoRA slots are shown, eliminating clutter
- ‚úÖ **Dynamic Height**: Node height automatically adjusts based on `lora_count`
- ‚úÖ **Backward Compatibility**: V1 node remains available for non-Beta users
- ‚úÖ **Feature Parity**: V2 provides complete feature parity with V1, including CPU offload support
- ‚úÖ **Future-Proof**: Uses ComfyUI Nodes 2.0 (Beta) best practices for long-term compatibility

## Backward Compatibility

- ‚úÖ **V1 Node Preserved**: The original `NunchakuQwenImageLoraStack` (V1) node remains available
- ‚úÖ **No Breaking Changes**: Existing workflows using V1 node continue to work
- ‚úÖ **Optional Migration**: Users can migrate to V2 node when ready
- ‚ö†Ô∏è **V1 Limitation**: V1 node still exhibits Issue #9 behavior (10th row always visible)
- ‚úÖ **Recommendation**: Use V2 node for ComfyUI Nodes 2.0 (Beta) or to fix Issue #9

## Migration Guide

### For New Users

- Use `NunchakuQwenImageLoraStackV2` node directly
- No migration needed

### For Existing V1 Users

**Option 1: Keep Using V1 (Not Recommended)**
- V1 node continues to work
- Issue #9 (10th row always visible) will persist
- May have compatibility issues with future ComfyUI Nodes 2.0 updates

**Option 2: Migrate to V2 (Recommended)**
1. Open your workflow in ComfyUI
2. Replace `NunchakuQwenImageLoraStack` nodes with `NunchakuQwenImageLoraStackV2`
3. Configure LoRA slots using the "üî¢ LoRA Count" combo box
4. Verify that only the selected number of LoRA slots are visible
5. Save your workflow

**Migration Benefits:**
- Issue #9 fixed (10th row no longer always visible)
- Cleaner UI with dynamic height adjustment
- Full ComfyUI Nodes 2.0 (Beta) compatibility
- Future-proof implementation

### For ComfyUI Nodes 2.0 (Beta) Users

- **Required**: Use `NunchakuQwenImageLoraStackV2` node
- V1 node may not work correctly with ComfyUI Nodes 2.0 (Beta)
- V2 node provides full compatibility

## Testing

### Verified Scenarios

- ‚úÖ V2 node creation and initialization
- ‚úÖ Dynamic UI updates when `lora_count` changes
- ‚úÖ 10th LoRA slot correctly hidden when `lora_count < 10`
- ‚úÖ Node height adjustment based on `lora_count`
- ‚úÖ LoRA loading and application with V2 node
- ‚úÖ CPU offload functionality with V2 node
- ‚úÖ Widget array reconstruction on node configure
- ‚úÖ Hidden `lora_count` widget sync with control widget
- ‚úÖ ComfyUI Nodes 2.0 (Beta) compatibility
- ‚úÖ Backward compatibility with V1 node

### Test Cases

**Test 1: Basic Functionality**
- Create V2 node
- Set `lora_count = 3`
- Verify only 3 LoRA slots are visible
- Verify node height is correct
- Load LoRAs and verify they apply correctly

**Test 2: Issue #9 Fix**
- Create V2 node
- Set `lora_count = 5`
- Verify 10th LoRA slot is NOT visible
- Change `lora_count` to 10
- Verify 10th LoRA slot becomes visible
- Change `lora_count` back to 5
- Verify 10th LoRA slot is hidden again

**Test 3: Dynamic Height**
- Create V2 node
- Set `lora_count = 1`
- Record node height
- Change `lora_count` to 10
- Verify node height increases correctly
- Change `lora_count` to 3
- Verify node height decreases correctly

**Test 4: Widget Sync**
- Create V2 node
- Change "üî¢ LoRA Count" combo box
- Verify hidden `lora_count` widget value syncs
- Verify Python backend receives correct value

**Test 5: ComfyUI Nodes 2.0 (Beta) Compatibility**
- Test V2 node with ComfyUI Nodes 2.0 (Beta)
- Verify all widgets display correctly
- Verify dynamic UI updates work
- Verify no console errors

## Technical Details

### Why Optional Inputs?

ComfyUI Nodes 2.0 (Beta) changed how widgets are managed. Using `optional` inputs allows JavaScript to:
1. Control which widgets appear in the `widgets` array
2. Physically reconstruct the array without breaking the node
3. Hide widgets by simply not including them in the array

### Why Widget Array Reconstruction?

Traditional widget hiding (using `widgethider.js` or negative heights) no longer works reliably with ComfyUI Nodes 2.0 (Beta). The Flux V2-style approach:
1. Creates a fresh widget array on each update
2. Only includes widgets for visible slots
3. Ensures clean UI without hidden widgets causing layout issues

### Why Keep V1's lora_count Widget?

The Python backend still expects a `lora_count` parameter. V2:
1. Keeps V1's `lora_count` widget in the array (for Python backend)
2. Hides it using `HIDDEN_TAG` and `computeSize = () => [0, -4]`
3. Syncs its value with V2's "üî¢ LoRA Count" combo box
4. Ensures Python backend receives correct value

### Flux V2-Style Implementation

V2 follows the same pattern used in Flux V2 LoRA stacker nodes:
- `ComfyUI-NunchakuFluxLoraStacker/js/z_flux_lora_dynamic.js`
- `ComfyUI-NunchakuFluxLoraStacker/js/lora_stacker_v2.js`

This ensures consistency and compatibility with ComfyUI Nodes 2.0 (Beta) best practices.

## Acknowledgments

- **Reported by**: @xingewh (GitHub Issue #9)
- **Special Thanks**: This fix was made possible by @xingewh's detailed bug report about the 10th LoRA control row always displaying
- **Inspiration**: Flux V2 LoRA stacker implementation for ComfyUI Nodes 2.0 (Beta) compatibility patterns

## Links

- **Issue #9**: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/9
- **Tags page**: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/tags
- **v1.70 release**: https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/releases/tag/v1.70
- **ComfyUI Nodes 2.0 (Beta)**: https://github.com/comfyanonymous/ComfyUI

