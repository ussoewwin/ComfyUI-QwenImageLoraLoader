# v2.1.0 Release Notes

## Summary

- **Fixed**: Resolved [Issue #33](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/33) – Fixed `AttributeError: 'NoneType' object has no attribute 'to'` by adding None checks to `to_safely` and `forward` methods in `ComfyQwenImageWrapper`
- **Reported by**: [@vvhitevvizard](https://github.com/vvhitevvizard) ([Issue #33](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/33))
- **Problem**: In certain environments, `ComfyQwenImageWrapper.to_safely()` method fails when `self.model` is `None` (after garbage collection), causing `AttributeError: 'NoneType' object has no attribute 'to'`
- **Solution**: Added `None` checks to `to_safely` and `forward` methods to safely handle cases where the model has been garbage collected or unloaded

## Problem

### AttributeError: 'NoneType' object has no attribute 'to'

When using LoRA loader nodes, `AttributeError: 'NoneType' object has no attribute 'to'` error occurs during model loading/unloading operations.

**Error Traceback:**

```
AttributeError: 'NoneType' object has no attribute 'to'

Traceback (most recent call last):
  File "D:_ai\ComfyUI\custom_nodes\ComfyUI-nunchaku\model_patcher.py", line 29, in load
    self.model.diffusion_model.to_safely(device_to)
  File "D:_ai\ComfyUI\custom_nodes\ComfyUI-QwenImageLoraLoader\wrappers\qwenimage.py", line 65, in to_safely
    self.model.to(device)
```

**Error occurs in two scenarios:**
1. During model loading (`model_patcher.py` line 29: `self.model.diffusion_model.to_safely(device_to)`)
2. During model detaching (`model_patcher.py` line 41: `self.model.diffusion_model.to_safely(self.offload_device)`)

### Root Cause

**ComfyUI 0.4.0 Model Management Changes:**

1. **Weak Reference-Based Model Management**
   - ComfyUI 0.4.0 introduced `weakref.ref(ModelPatcher)` in `model_management.py`
   - When a model is garbage collected, weak references return `None`

2. **Earlier Automatic Unloading**
   - Compared to ComfyUI 0.3.x, automatic model unloading occurs earlier
   - Garbage collection timing has changed

3. **Missing None Checks**
   - The `to_safely` method in `ComfyQwenImageWrapper` did not check if `self.model` is `None` before calling `self.model.to(device)`
   - When `self.model` becomes `None` after GC, calling `None.to(device)` raises `AttributeError`

**Why `hasattr` check alone is insufficient:**

```python
# Original code (problematic)
def to_safely(self, device):
    if hasattr(self.model, "to_safely"):
        self.model.to_safely(device)
    else:
        self.model.to(device)  # ← AttributeError if self.model is None
```

When `self.model` is `None`, `hasattr(None, "to_safely")` returns `False`, so the code enters the `else` block and tries to call `None.to(device)`, causing the error.

## Solution

### Fix: Add None Checks

**1. Added None check to `to_safely` method:**

```python
def to_safely(self, device):
    """Safely move the model to the specified device."""
    if self.model is None:
        return self
    if hasattr(self.model, "to_safely"):
        self.model.to_safely(device)
    else:
        self.model.to(device)
    return self
```

**2. Added None check to `forward` method (defensive programming):**

```python
def forward(self, x, timestep, context=None, y=None, guidance=None, control=None, transformer_options={}, **kwargs):
    """Forward pass for the wrapped model."""
    # ... (preprocessing code) ...
    
    # Guard against None model (can happen during GC/unload)
    if self.model is None:
        raise RuntimeError("Model has been unloaded or garbage collected. Cannot perform forward pass.")
    
    # ... (remaining processing) ...
```

### Why This Fix Works

1. **Safety Improvement**
   - `to_safely` now safely handles `None` model without crashing
   - Early return when model is `None` is appropriate (no object to move)

2. **Defensive Programming**
   - `forward` method explicitly detects and reports invalid state
   - Clear error messages aid debugging

3. **Compatibility with ComfyUI 0.4.0**
   - Works with weak reference-based model management
   - Handles GC timing differences across environments

## Relationship with Issue #25

Issue #33 shares the same root cause as [Issue #25](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/25): ComfyUI 0.4.0's weak reference-based model management.

**Differences:**
- **Issue #25**: Primarily `copy.deepcopy` and `pinned` attribute errors (fixed by temporarily setting `model_config` to `None`)
- **Issue #33**: Primarily `to_safely` method `AttributeError` (fixed by adding `None` checks)

Both fixes complement each other to provide robust handling of ComfyUI 0.4.0's model management changes.

## Testing

### Verified Scenarios

- ✅ `to_safely` succeeds when `self.model` is `None` (early return)
- ✅ `to_safely` succeeds when `self.model` exists normally
- ✅ `forward` raises clear error when `self.model` is `None`
- ✅ Model loading/unloading operations complete without errors
- ✅ Workflow execution is stable

## Related Issues

- [Issue #33](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/33) - AttributeError: 'NoneType' object has no attribute 'to'
- [Issue #25](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/issues/25) - AttributeError: 'NunchakuModelPatcher' object has no attribute 'pinned'
- [COMFYUI_0.4.0_UPDATE_ERROR_FIXES.md](https://github.com/ussoewwin/ComfyUI-QwenImageLoraLoader/blob/main/COMFYUI_0.4.0_UPDATE_ERROR_FIXES.md) - ComfyUI core fixes

